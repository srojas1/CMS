function cmsCommentSubmit(e){$(e).ajaxSubmit({url:$("#comments").data("url")+"/"+$(e).data("pk"),dataType:"json",clearForm:!0,resetForm:!0,timeout:5e3,success:function(e,m,t){return t.responseJSON&&t.responseJSON.success===!0&&t.responseJSON.msg&&t.responseJSON.comment_id&&t.responseJSON.comment_ver&&t.responseJSON.comment_text?($("#comment_"+t.responseJSON.comment_id).data("ver",t.responseJSON.comment_ver),void $("#main_comment_"+t.responseJSON.comment_id).fadeOut(cmsCommentTime/2,function(){$(this).html(t.responseJSON.comment_text),$(this).fadeIn(cmsCommentTime/2,function(){$("#edit_comment").modal("hide")})})):void $("#edit_comment").modal("hide")},error:function(e,m,t){$("#edit_comment").modal("hide")}})}function cmsCommentEditShow(e){$("#edit_commentform").data("pk",$(e).data("pk")),$("#verion").attr("value",$("#comment_"+$(e).data("pk")).data("ver")),$("#edit_body").val($("#main_comment_"+$(e).data("pk")).text().replace(/<br\s*[\/]?>/gi,"\n")),$("#edit_comment").modal("show")}function cmsCommentEdit(e){e=e||".editable",$(e).click(function(){var e=this,m=setInterval(function(){0==cmsCommentLock&&(clearInterval(m),cmsCommentLock=!0,cmsCommentEditShow(e))},10);return!1})}function cmsCommentModel(){$("#edit_comment").on("hidden.bs.modal",function(){cmsCommentLock=!1}),$("#edit_comment_ok").click(function(){$("#edit_commentform").trigger("submit")}),$("textarea#edit_body").keydown(function(e){e.ctrlKey&&13===e.keyCode&&$("#edit_commentform").trigger("submit")}),$("#edit_commentform").submit(function(){var e=this;return cmsCommentSubmit(e),!1})}function cmsCommentDeleteSubmit(e){$.ajax({url:$(e).attr("href"),type:"DELETE",dataType:"json",timeout:5e3,success:function(e,m,t){return t.responseJSON&&t.responseJSON.success===!0&&t.responseJSON.msg&&t.responseJSON.comment_id?void $("#comment_"+t.responseJSON.comment_id).slideUp(cmsCommentTime,function(){$(this).remove(),0==$("#comments > div").length&&0==$("#comments > p").length?$('<p id="nocomments">There are currently no comments.</p>').prependTo("#comments").hide().fadeIn(cmsCommentTime,function(){cmsCommentLock=!1}):cmsCommentLock=!1}):void(cmsCommentLock=!1)},error:function(e,m,t){cmsCommentLock=!1}})}function cmsCommentDelete(e){e=e||".deletable",$(e).click(function(){var e=this,m=setInterval(function(){0==cmsCommentLock&&(clearInterval(m),cmsCommentLock=!0,cmsCommentDeleteSubmit(e))},10);return!1})}function cmsCommentMessage(e,m){$("#commentstatus").replaceWith('<label id="commentstatus" class="has-'+m+'"><div class="editable-error-block help-block" style="display: block;">'+e+"</div></label>")}function cmsCommentCreateSubmit(e){cmsCommentMessage("Submitting comment...","info"),$(e).ajaxSubmit({dataType:"json",clearForm:!0,resetForm:!0,timeout:5e3,success:function(e,m,t){return t.responseJSON?t.responseJSON.success===!0&&t.responseJSON.msg&&t.responseJSON.contents&&t.responseJSON.comment_id?(cmsCommentMessage(t.responseJSON.msg,"success"),void(0==$("#comments > div").length?$("#nocomments").fadeOut(cmsCommentTime,function(){$(this).remove(),$(t.responseJSON.contents).prependTo("#comments").hide().slideDown(cmsCommentTime,function(){cmsTimeAgo("#timeago_comment_"+t.responseJSON.comment_id),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentLock=!1})}):$(t.responseJSON.contents).prependTo("#comments").hide().slideDown(cmsCommentTime,function(){cmsTimeAgo("#timeago_comment_"+t.responseJSON.comment_id),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentLock=!1}))):t.responseJSON.msg?(cmsCommentMessage(t.responseJSON.msg,"error"),void(cmsCommentLock=!1)):(cmsCommentMessage("There was an unknown error!","error"),void(cmsCommentLock=!1)):(cmsCommentMessage("There was an unknown error!","error"),void(cmsCommentLock=!1))},error:function(e,m,t){return e.responseJSON&&e.responseJSON.msg?(cmsCommentMessage(e.responseJSON.msg,"error"),void(cmsCommentLock=!1)):(cmsCommentMessage("There was an unknown error!","error"),void(cmsCommentLock=!1))}})}function cmsCommentCreate(e,m){e=e||"#commentform",m=m||"textarea#body",$(e).submit(function(){cmsCommentMessage("Waiting for lock to clear...","info");var e=this,m=setInterval(function(){0==cmsCommentLock&&(cmsCommentLock=!0,clearInterval(m),cmsCommentCreateSubmit(e))},10);return!1}),$(m).keydown(function(m){m.ctrlKey&&13===m.keyCode&&$(e).trigger("submit")})}function cmsCommentFetchGet(){return 0!=cmsCommentFetchData.length?void $.ajax({url:$("#comments").data("url")+"/"+cmsCommentFetchData[0],type:"GET",dataType:"json",timeout:5e3,success:function(e,m,t){return t.responseJSON&&t.responseJSON.contents&&t.responseJSON.comment_id?void(0==$("#comments > div").length?$("#nocomments").fadeOut(cmsCommentTime,function(){$(this).remove(),$(t.responseJSON.contents).prependTo("#comments").hide().slideDown(cmsCommentTime,function(){cmsTimeAgo("#timeago_comment_"+t.responseJSON.comment_id),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentFetchData.splice(0,1),cmsCommentFetchGet()})}):$(t.responseJSON.contents).prependTo("#comments").hide().slideDown(cmsCommentTime,function(){cmsTimeAgo("#timeago_comment_"+t.responseJSON.comment_id),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentEdit("#editable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_1"),cmsCommentDelete("#deletable_comment_"+t.responseJSON.comment_id+"_2"),cmsCommentFetchData.splice(0,1),cmsCommentFetchGet()})):(cmsCommentFetchData.splice(0,1),void cmsCommentFetchGet())},error:function(e,m,t){cmsCommentFetchData.splice(0,1),cmsCommentFetchGet()}}):void(0==$("#comments > div").length&&0==$("#comments > p").length?$('<p id="nocomments">There are currently no comments.</p>').prependTo("#comments").hide().fadeIn(cmsCommentTime,function(){cmsCommentLock=!1,cmsCommentFetch()}):(cmsCommentLock=!1,cmsCommentFetch()))}function cmsCommentFetchNew(){var e=cmsCommentFetchRaw.length;cmsCommentFetchData=new Array;for(var m=0;m<e;m++){var t=!1;$("#comments > div").each(function(){$(this).data("pk")==cmsCommentFetchRaw[m].comment_id&&(t=!0)}),0==t&&cmsCommentFetchData.push(cmsCommentFetchRaw[m].comment_id)}cmsCommentFetchGet()}function cmsCommentFetchReplace(){return 0!=cmsCommentFetchData.length?void $.ajax({url:$("#comments").data("url")+"/"+cmsCommentFetchData[0],type:"GET",dataType:"json",timeout:5e3,success:function(e,m,t){return t.responseJSON&&t.responseJSON.comment_id&&t.responseJSON.comment_ver&&t.responseJSON.comment_text?($("#comment_"+t.responseJSON.comment_id).data("ver",t.responseJSON.comment_ver),void $("#main_comment_"+t.responseJSON.comment_id).fadeOut(cmsCommentTime/2,function(){$(this).html(t.responseJSON.comment_text),$(this).fadeIn(cmsCommentTime/2,function(){cmsCommentFetchData.splice(0,1),cmsCommentFetchReplace()})})):(cmsCommentFetchData.splice(0,1),void cmsCommentFetchReplace())},error:function(e,m,t){cmsCommentFetchData.splice(0,1),cmsCommentFetchReplace()}}):void cmsCommentFetchNew()}function cmsCommentFetchUpdate(){var e=cmsCommentFetchRaw.length;cmsCommentFetchData=new Array;for(var m=0;m<e;m++)$("#comments > div").each(function(){$(this).data("pk")==cmsCommentFetchRaw[m].comment_id&&$(this).data("ver")!=cmsCommentFetchRaw[m].comment_ver&&cmsCommentFetchData.push(cmsCommentFetchRaw[m].comment_id)});cmsCommentFetchReplace()}function cmsCommentFetchProcess(){var e=cmsCommentFetchRaw.length,m=0,t=0;$("#comments > div").each(function(){for(var n=!1,o=0;o<e;o++)$(this).data("pk")==cmsCommentFetchRaw[o].comment_id&&(n=!0);0==n&&(m++,$(this).slideUp(cmsCommentTime,function(){$(this).remove(),t++}))});var n=setInterval(function(){m===t&&(clearInterval(n),cmsCommentFetchUpdate())},10)}function cmsCommentFetchWork(){$.ajax({url:$("#comments").data("url"),type:"GET",dataType:"json",timeout:5e3,success:function(e,m,t){return t.responseJSON?(cmsCommentFetchRaw=t.responseJSON,void cmsCommentFetchProcess()):(cmsCommentLock=!1,void cmsCommentFetch())},error:function(e,m,t){return e.responseJSON&&e.responseJSON.url&&404==e.responseJSON.code?void $("body").fadeOut(1e3,function(){window.location.replace(e.responseJSON.url)}):(cmsCommentLock=!1,void cmsCommentFetch())}})}function cmsCommentFetchWait(){var e=setInterval(function(){0==cmsCommentLock&&(cmsCommentLock=!0,clearInterval(e),cmsCommentFetchWork())},10);return!1}function cmsCommentFetch(){setTimeout(function(){cmsCommentFetchWait()},cmsCommentInterval)}var cmsCommentLock=!0,cmsCommentFetchRaw,cmsCommentFetchData;$(document).ready(function(){cmsCommentEdit(),cmsCommentModel(),cmsCommentDelete(),cmsCommentCreate(),cmsCommentFetch(),cmsCommentLock=!1});